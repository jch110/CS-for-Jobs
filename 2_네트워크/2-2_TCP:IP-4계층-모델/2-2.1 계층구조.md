# **TCP/IP**
TCP/IP 는 OSI 7계층과 많이 비교됨.

<img src="2-2.1 TCPIP.png">

<br>

<img src="2-2.1 TCPIP OSI 차이.png">

<br>

특정 계층이 변경되었을 때 다른 계층이 영향을 받지 않도록 설계

<br>

<img src="2-2.1 TCPIP 대표 스택.png">

<br>

## 애플리케이션 계층

웹서비스, 이메일 등 서비스를 실질적으로 제공

- FTP(port 20, 21) : 장치와 장치 간의 파일을 전송하는 데 사용되는 표준 통신 프로토콜
- SSH(port 22) : 보안되지 않은 네트워크에서 서비스를 안전하게 운영하기 위한 암호화 프로토콜
- HTTP(port 80) : World Wide Web 을 위한 데이터통신의 기초, 웹사이트 프로토콜 
- SMTP(port 25) : 전자메일 전송을 위한 인터넷 표준 통신 프로토콜
- DNS(port 53) : 도메인 이름과 IP 주소를 매핑해주는 서버

<br>

특정 프로토콜에서 이미 사용하고 있는 포트들을 **well-known port** 라고 함

<br>

## 전송 계층

송신자와 수신자를 연결하는 통신 서비스 제공

대표적으로 TCP/UDP 가 있다.

<br>

### TCP - 가상회선 패킷 교환 방식   
각 패킷에 가상회선 식별자가 포함, 모든 패킷 전송되면 가상회선이 해제되고 패킷들은 순서대로 도착

<br>

<img src="2-2.1 가상회선 패킷 교환 방식.png">

<br>

### UDP - 데이터그램 패킷 교환 방식
패킷이 독립적으로 이동하며 최적의 경로를 선택   
하나의 메시지의 여러 패킷은 서로 다른 경로, 다른 순서로 도착

<br>

<img src="2-2.1 데이터그램 패킷 교환 방식.png">

<br>

### **TCP 연결 성립 과정**(3-way handshake)


양쪽 모두 데이터를 전송할 준비가 되어있다는 것을 보장하고,   
실제로 데이터 전달을 시작하기 전에 다른 한쪽이 준비되었다는 것을 알 수 있도록 해준다.

<img src="2-2.1 3way handshake.png">

<br>

### **[State 정보]**

CLOSED: 포트가 닫힌 상태  
LISTEN: 포트가 열린 상태로 연결 요청 대기 중   
SYN_RECV: SYNC 요청을 받고 상대방의 응답을 기다리는 중   
ESTABLISHED: 포트 연결 상태   
TIME-WAIT: Server로부터 FIN을 수신하더라도 일정시간(default: 240초)동안 세션을 남겨놓고 잉여 패킷을 기다리는 과정을말한다.    

<br>

### **[Flag 정보]**

TCP Header에는 CONTROL BIT(플래그 비트, 6bit)가 존재하며, 각각의 bit는 "URG-ACK-PSH-RST-SYN-FIN"의 의미를 가진다.   
즉, 해당 위치의 bit가 1이면 해당 패킷이 어떠한 내용을 담고 있는 패킷인지를 나타낸다.   

**SYN(Synchronize Sequence Number)**  

연결 설정. Connection을 생성할때 사용하는 flag   
Sequence Number를 랜덤으로 설정하여 세션을 연결하는 데 사용하며, 초기에 Sequence Number를 전송한다.   <br><br>
**ACK(Acknowledgement)**   

응답 확인. 패킷을 받았다는 것을 의미하는 flag      
Acknowledgement Number 필드가 유효한지를 나타낸다.   
양단 프로세스가 쉬지 않고 데이터를 전송한다고 가정하면 최초 연결 설정 과정에서 전송되는 첫 번째 세그먼트를 제외한 모든 세그먼트의 ACK 비트는 1로 지정된다고 생각할 수 있다.   <br><br>
**FIN(Finish)**   

연결 해제. 세션 연결을 종료   
더 이상 전송할 데이터가 없음을 의미한다.   
4way handshake에서 사용한다.

<br><br>

### **[3way handshake 과정]**

**Step1 [Client -> SYN -> Server]**

Client가 Server에게 접속을 요청하는 SYN플래그를 보낸다.

 

**Step2. [Server -> SYN + ACK -> Client ]**

Server는 Listen상태에서 SYN이 들어온 것을 확인하고 SYN_RECV상태로 바뀌어 SYN + ACK플래그를 Client에게 전송한다.   
 그 후 Server는 다시 ACK 플래그를 받기 위해 대기상태로 변경된다.

 

**Step3. [Client -> ACK -> Server]**

SYN + ACK 상태를 확인한 Client는 서버에게 ACK를 보내고 연결 성립(Established)이 된다. 

<br>

### **4-Way Handshake란?**
세션을 종료하기 위해 수행되는 절차

<img src="2-2.1 4way handshake.png">

<br>

### **[4way handshake 과정]**

<br>

**Step1 [Client -> FIN -> Server]**

Client가 연결을 종료하겠다는 FIN플래그를 전송한다. 보낸 후에 FIN-WAIT-1 상태로 변한다.

**Step2 [Server-> ACK -> Client]**

FIN 플래그를 받은 Server는 확인메세지인 ACK를 Client에게 보내준다. 그 후 CLOSE-WAIT상태로 변한다. Client도 마찬가지로 Server에서 종료될 준비가 됐다는 FIN을 받기위해  FIN-WAIT-2 상태가 된다.

**Step3 [Server -> FIN -> Client]**

Close준비가 다 된 후 Server는 Client에게 FIN 플래그를 전송한다.

**Step4 [Client -> ACK-> Server]**

Client는 해지 준비가 되었다는 정상응답인 ACK를 Server에게 보내준다. 이 때, Client는 TIME-WAIT 상태로 변경된다.   

TIME-WAIT 상태는 의도치않은 에러로 인해 연결이 데드락으로 빠지는 것을 방지하기 위해 변경 되는 것인데, 만약 에러로 인해 종료가 지연되다가 타임이 초과되면 CLOSED 상태로 변경된다.

CentOS6, 우분투에는 60초로 설정되어 있으며 윈도우는 4분으로 설정되어있다.

<br>

## **인터넷 계층**

장치로부터 받은 네트워크 패킷을 IP 주소로 지정된 목적지로 전송하기 위해 사용되는 계층

 IP, ARP, ICMP 등이 있으며 패킷을 수신해야 할 상대의 주소를 지정하여 데이터를 전달합니다.
   
<br>

- IP(Internet Protocol) : 비신뢰성, 비연결지향 데이터그램 프로토콜입니다. 

- ARP(Address Resolution Protocol) : 주소변환 프로토콜입니다. IP주소를 MAC주소로 변환하는 프로토콜이지요.

- RARP(Reverse ARP) : 반대로 MAC주소로 IP주소를 찾는 프로토콜입니다.

- ICMP(Internet Control Message Protocol) : 상태 진단 메시지 프로토콜인데요. 이 프로토콜을 이용하는 대표적인 프로그램이 ping입니다.

- IGMP(Internet Group Message Protocol) : 멀티캐스트용 프로토콜입니다.



 <br>

 ## **링크 계층**

 전선, 광섬유, 무선 등 으로 실질적으로 데이터를 전달하며 장치간에 신호를 주고 받는 '규칙'을 정하는계층

<br>

### **링크 계층 서비스**

- framing : 데이터그램을 헤더와 트레일러를 붙여 frame 단위로 포장해줌
- flow control : 인접한 노드 간의 송신과 수신의 속도를 제어
- error detection : 에러(신호 감쇠, 노이즈로 인해 발생)를 수신자가 탐지해서 재송신 받거나 버림
- error correction : 수신자가 에러 탐지 후 비트 오류를 스스로 수정


 물리 계층 - 무선LAN과 유선LAN을 통해 0과 1로 이루어진 데이터를 보내는 계층

 데이터 링크 계층 - '이더넷프레임'을 통해 에러확인, 흐름제어, 접근제어를 담당하는 계층

 <br>

### **링크의 종류**

point-to-point : 어떤 지점에서 다른 지점으로 보내는 방식

Broadcast : 연결된 모두에게 알려주는 방식

<br>

### **다중 접근 프로토콜**(multiple access protocol)
  - 채널 파티셔닝 : R 속도의 브로드캐스트 채널에 M 명이 연결되어있다면 각자가 R/M씩 보내면 충돌 없다.

  - 랜덤 접근 : 채널이 나눠져있지 않고, 충돌을 허용. 충돌나면 그것을 회복시키는데 집중

  - 순번 접근 : 돌아가면서 보내는 것(보내던거 마저 보내도록 배려) 

 <br>

 ### **채널 파티셔닝**(channel partitioning MAC protocols)
- TDMA(Time Division Multiple Access) : 시분할 방식. 라운드를 거치며 각자의 라운드에 패킷을 전송
  
- FDMA(Frequency Division Multiple Access) : 한 채널을 주파수 영역으로 나눠 각자의 주파수로 데이터를 전송

### **랜덤 접근 프로토콜**(random access MAC protocol)
- 다른 채널의 상황을 고려하지 않고 바로 전송

- 충돌이 난다면 회복에 집중

- slotted ALOHA, ALOHA, CSMA, CSMA/CD, CSMA/CA 등


 ### **유선 LAN**(IEEE 802.3)

송신로와 수신로로 나눠 양쪽 장치가 동시에 송수신이 가능하다.   
ex) 고속 이더넷

 <img src="2-2.1 전이중화 통신.png">

 <br>

### **유선 LAN을 이루는 케이블**

TP케이블이라고 하는 트위스트 페어 케이블과 광섬유 케이블이 대표적

<br>

### 트위스트 페어 케이블
<br>

<img src="2-2.1 TPcable.png">

여덟개의 구리선을 두개씩 꼬아서 묶은 케이블

구리선을 실드 처리하지 않고 덮은 UTP케이블과 실드처리하고 덮은 STP로 나눠짐.   
여기서 우리가 많이 볼 수 있는 케이블은 UTP케이블로 LAN케이블과 동일.

<img src="2-2.1 LAN&RJ-45.png">
LAN케이블을 꽂을 수 있는 커넥터를 RJ-45커넥터라고 함

<br>

### 광섬유 케이블

<img src="2-2.1 광섬유 케이블.png">

레이저를 이용해서 통신 -> 장거리 및 고속 통신

빛의 굴절률 높은 부분 코어(core)  
빛의 굴절률 낮은 부분 클래딩(cladding)


### **무선 LAN**(IEEE 802.11)

무선 LAN장치는 수신과 송신에 같은 채널을 사용하기 때문에 반이중화 통신을 사용

<br>

<img src="2-2.1 반이중화 통신.png">
half duplex

동시에는 통신 할 수 없으며 한 번에 한 방향만 통신 할 수 있다.

둘 이상의 장치가 동시에 전송하면 충돌이 발생할 수 있기 때문에   
**충돌 방지 시스템**을 이용한다.   
-> 무선 환경에서는 충돌을 감지하기 힘들기 때문에 충돌을 미연에 방지한다.

### CSMA/CA
1. 사용중인 채널이 있다면 다른 채널을 감지하다 유후 상태인 채널을 탐색

2. IFS(InterFrame Space, 프레임 간 공간시간)시간만큼 대기. IFS가 낮으면 우선순위가 높다.

3. 프레임을 보내기전 0 ~ 2^k - 1 사이에서 결정된 랜덤상수를 기반으로 결정된 시간만큼 기다린 뒤 프레임을 전송. 
4. 프레임을 보낸 뒤 ACK 세그먼트 받으면 중단. 
5. 그러나 받지 못했다면 k = k + 1 을 하며 이 과정을 반복. 
6. 반복하다 k가 정해진 Kmax 보다 더 커진다면 해당 프레임전송은 기각.


<br>

### 무선 LAN을 이루는 주파수

비유도 매체인 공기에 주파수를 쏘아 무선 통신망을 구축

2.4GHz대역 : 장애물에 강한 특성   

5GHz대역 : 채널 수 많고 동시 사용 가능

<br>

### **와이파이**(WI-FI)

- 전자기기들이 무선 LAN신호에 연결할 수 있게하는 기술
- 공유기(Access Point)를 이용하여 유선 LAN을 무선 LAN 신호로 바꾸어 연결

<br>

### **BSS**(Basic Service Set)

- 기본 서비스 집합
- BSS내에 있는 AP들과 장치들이 서로 통신이 가능한 구조
- 근거리 무선 통신을 제공하고, 하나의 AP만을 기반으로 구축


### **ESS**(Extended Service Set)

- 하나 이상의 연결된 BSS 그룹
- 장거리 무선 통신을 제공하며 BSS보다 더 많은 가용성과 이동성을 지원


<img src="2-2.1 BSS&ESS.png">

<br>

### **이더넷 프레임**

<img src="2-2.1 Ethernet-Frame.png">

- Preamble : 이더넷 프레임이 시작
- SFD(Start FrameDelimiter):다음 바이트부터 MAC 주소 필드임을 확인
- DMAC, SMAC: 수신, 송신 MAC주소
- EtherType: 데이터 계층위의 계층인 IP 프로토콜을 정의. (IPv4 or IPv6) 
- Payload: 전달 받은 데이터
- CRC:에러 확인 비트

<br>


### **계층간 데이터 송수신**

<img src="2-2.1 데이터 송수신 과정.png">

request를 보내는 애플리케이션층 부터 **캡슐화**가 진행   
response를 받고 난 후 역순으로 링크 계층부터 **비캡슐화** 진행


<br>

### **캡슐화**

<img src="2-2.1 캡슐화 과정.png">

<br>

1. 애플리케이션 계층 : 데이터 전송 시작
2. 전송 계층 : 데이터의 *세그먼트*화 or *데이터 그램*화 후 TCP(L4)헤더 추가
3. 인터넷 계층 : IP(L3) 헤더가 붙여지게 되며 *패킷화*
4. 링크 계층 : 프레임 헤더와 프레임 트레일러가 붙어 *프레임화*

<br>

### **비캡슐화**

<img src="2-2.1 비캡슐화 과정.png">

<br>

위의 과정을 역순으로 돌며 최종적으로 사용자에게 애플리케이션의 PDU인 메시지로 전송

<br>

## **PDU**(Protocol Data Unit)

계층에서 계층으로 데이터가 전달 될 때 덩어리의 단위

제어 관련 정보들이 포함된'헤더', 데이터를 의미하는'페이로드'로 구성

<br>

### 계층마다의 명칭

- 애플리케이션계층 : 메시지   
- 전송계층 : 세그먼트(TCP), 데이터그램(UDP)
- 인터넷계층 : 패킷
- 링크계층 : 프레임(데이터링 크계층), 비트(물리계층)

